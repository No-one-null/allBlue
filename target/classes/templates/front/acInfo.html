<!DOCTYPE html >
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>AllBlue动漫网</title>
</head>
<body class="container">
<!-- 导航栏-->
<nav th:replace="/index :: head"></nav>
<a href="#top" class="goTop"><img th:src="@{/images/icon/top.gif}"></a>
<div class="col-md-12 panel panel-info">
    <div class="title-div panel-heading">
        <h4><b><span th:text="${ac.name}"></span></b></h4>
    </div>
    <!--详情-->
    <div class="col-md-6 detail-div">
        <div class="img-div">
            <img th:src="${#strings.isEmpty(ac.image)}?'images/none.png':'images/cover/'+${ac.image}"
                 class="img-rounded img-thumbnail" alt="封面/海报">
        </div>
        <div class="list-group">
            <li class="list-group-item"><b>类别:</b><a href="#"> [[${ac.category=='A'?'动画':'漫画'}]]</a></li>
            <li class="list-group-item"><b th:text="${ac.category}=='C'?'作者:':'导演:'"></b><a href="#">
                [[${ac.author}]]</a></li>
            <li class="list-group-item"><b>时间:</b><a href="#"> [[${ac.year}]]</a></li>
            <li class="list-group-item"><b>地域:</b><a href="#"> [[${ac.country}]]</a></li>
            <li class="list-group-item" s><b>标签:</b><a href="#"> (少年漫画)</a></li>
            <div hidden>有东西？</div>
            <input type="button" class="btn btn-default btn-block" value="更多">
        </div>
    </div>
    <div class="col-md-6 info-div">
        <pre th:if="${#strings.isEmpty(ac.info)}">暂无简介……<a href="#"><em>添加简介？</em></a></pre>
        <pre th:if="!${#strings.isEmpty(ac.info)}">[[${ac.info}]]</pre>
        <p style="text-align: center"><a href="#"><i>信息有误? 报错！</i> </a></p>
    </div>
    <div class="col-md-6 link-div">
        观看链接
    </div>
    <div class="col-md-6 mark-div">
        <div class="rating-div">
            <div class="rating-star-div">
                <div class="cell">
                    <h1></h1>
                    <span class="star"></span><br>
                    <i><span></span>人评价</i>
                </div>
            </div>
            <div class="rating-chart-div">
                条形图
            </div>
        </div>
        <div class="my-mark-div">
            <div class="cell">
                <a th:if="${session.currentUser}==null" th:href="@{/login}">登录可收藏该作品</a>
            </div>
        </div>
    </div>
    <div class="col-md-6 comment-btn-div">
        <input type="button" class="btn btn-info btn-block" id="comment-btn" value="吐槽一下">
        <a name="comments" id="comments"></a>
    </div>
</div>
<!--评论区-->
<div class="col-md-12 comment-div"></div>
<!--评论分页-->
<div class="col-md-12 comment-div-bottom">
    <div class="cell">
        <input type="button" class="btn btn-primary left-btn" value="更新">
        <input type="button" class="btn btn-default right-btn" value="关闭">
    </div>
</div>
<div class="col-md-6 comment-model panel-warning" hidden>
    <div class="panel-heading">
        <h3 class="panel-title">吐槽
            <input type="button" value="发布" style="float: right;">
        </h3>
    </div>
    <div class="panel-body">
        <textarea style="width: 100%;margin-top: 0" rows="5"></textarea>
    </div>
</div>
<!-- 模态框（Modal） -->
<div class="modal fade col-md-12" id="myModal" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 class="modal-title" id="myModalLabel"></h4>
            </div>
            <div class="modal-body">
                <!--评分评论表单-->
                <form class="form-horizontal mark-form" role="form" method="post" th:action="@{/mark(acId=${ac.id})}"
                      id="mark-form">
                    <!--                    <input type="hidden" name="acId" th:value="$">-->
                    <div class="form-group">
                        <label class="control-label col-md-2">进度</label>
                        <div id="progress" class="col-md-10">
                            <label class="radio-inline">
                                <input type="radio" name="progress" id="wish" value=1>想看
                            </label>
                            <label class="radio-inline">
                                <input type="radio" name="progress" id="do" value=2>在看
                            </label>
                            <label class="radio-inline">
                                <input type="radio" name="progress" id="collect" value=3>看过
                            </label>
                            <label class="radio-inline">
                                <input type="radio" name="progress" id="on_hold" value=4>搁置
                            </label>
                            <label class="radio-inline">
                                <input type="radio" name="progress" id="dropped" value=5>已弃
                            </label>
                        </div>
                    </div>
                    <div class="from-group rating-star">
                        <label class="control-label col-md-2">评分</label>
                        <input type="checkbox" name="rating" id="rating" hidden>
                        <div class="col-md-10 rating">
                            <a href="#"><img th:src="@{/images/star-empty.gif}" alt="1"></a>
                            <a href="#"><img th:src="@{/images/star-empty.gif}" alt="2"></a>
                            <a href="#"><img th:src="@{/images/star-empty.gif}" alt="3"></a>
                            <a href="#"><img th:src="@{/images/star-empty.gif}" alt="4"></a>
                            <a href="#"><img th:src="@{/images/star-empty.gif}" alt="5"></a>
                        </div>
                    </div>
                    <br>
                    <div class="form-group">
                        <label class="control-label col-md-2">吐槽</label>
                        <textarea id="comment" name="comment" rows="5" class="col-md-10"></textarea>
                    </div>
                    <hr>
                    <div>
                        <button type="button" class="btn btn-primary submit">提交</button>
                        <button type="button" class="btn btn-default" data-dismiss="modal" style="float: right;">关闭
                        </button>
                    </div>
                </form>
            </div>
        </div><!-- /.modal-content -->
    </div>
</div><!-- /.modal -->
</body>
</html>
<script type="text/javascript">
    //星星
    function star(num) {
        num = Math.round(num);
        var star = "";
        for (var i = 0; i < num; i++) {
            star += "★";
        }
        for (var i = num; i < 5; i++) {
            star += "☆";
        }
        return star;
    };

    //进度
    function progress(num) {
        var strs = ["暂无", "想看", "在看", "看过", "搁置", "已弃"];
        return strs[num];
    }

    //时间格式化
    function dateFormat(times) {
        var dates=new Date(times);
        var Y=dates.getFullYear();
        var M=dates.getMonth();
        var D=dates.getDate();
        var h=dates.getHours();
        var m=dates.getMinutes();
        var s=dates.getSeconds();
        var dateTime=Y+"-"+M+"-"+D+" "+h+":"+m+":"+s;
        return dateTime;
    }

    /**评分**/
    function showRating(rating, userNum) {
        if (rating > 0) {
            $(".rating-star-div div h1").html(rating);
        }
        if (rating <= 0) {
            $(".rating-star-div div h1").html("暂无");
        }
        $(".rating-star-div div .star").html(star(rating));
        $(".rating-star-div div i span").html(userNum);
    }

    //查询更新评分
    function queryRatingData() {
        $.post("[[@{/rating}]]",
        {
            acId: [[${ac.id}]]
        }, function (data, status) {
            if (status == 'success') {
                showRating(data.acRating, data.userNum);
            } else {
                alert("系统繁忙!");
            }
        });
    }

    //我的收藏
    function myMark() {
        $.ajax({
            url: "[[@{/myMark(acId=${ac.id})}]]",
            dataType: "json",
            type: "post",
            async: "false",
            success: function (data) {   //如果请求成功，返回数据。
                var html = "<div style='width: 50%;float: left;'>我的评价:";
                if (data.myMark == null) {
                    html += "<a onclick='addMark()' href='#' " +
                        "class='data-toggle='tooltip' title='添加评价'>未评价</a>";
                } else {
                    html += "<a href='#' onclick='editMark()' " +
                        "class='data-toggle='tooltip' title='修改评分'>" +
                        "<span>" + star(data.myMark.rating) + "</span></a>";
                }
                html += "</div><div style='width: 50%;float:right;'>我的进度:";
                if (data.myMark == null) {
                    html += "<a onclick='addMark()' href='#' " +
                        "data-toggle='tooltip' data-placement='top' title='添加收藏'>暂无</a>";
                } else {
                    html += "<a href='#' onclick='editMark()' " +
                        "data-toggle='tooltip' data-placement='top' title='修改进度'>" +
                        "<span>" + progress(data.myMark.progress) + "</span></a>";
                }
                html += "</div>";
                $(".my-mark-div div").html(html); //在html页面id=test的标签里显示html内容
                queryRatingData();
            }
        });
    };

    //添加收藏
    function addMark() {
        $("#progress").find(":radio").removeAttr("checked");
        $(".rating a").children().attr("src", "/images/star-empty.gif");
        $("#myModalLabel").html("加入收藏")
        $("#myModal").modal();
    }

    function editMark() {
        $.post("[[@{/myMark}]]",
            {
                acId: [[${ac.id}]]
            },
            function (data, status) {
                if (status == "success") {
                    $("#progress").find("input[value=" + data.myMark.progress + "]").attr("checked", "true");
                    var a = $(".rating").find("img[alt=" + data.myMark.rating + "]").click();
                    $("#comment").val(data.myMark.comment);
                    $("#myModalLabel").html("修改");
                    $("#myModal").modal();
                } else {
                    alert("系统繁忙,请重试!");
                }
            });
    }

    function showComments() {
        $.post("[[@{/showComments}]]",{acId:3},
        function (data,status) {
            if(status=='success'){
                html="";
                for(var i=0;i<data.comment.length;i++){
                    html+="<div class='user-comment'" +
                        "        <div class='cell' style='background-color: #8DB6CD;'>\n" +
                        "            <span class='badge'>"+data.comment[i].user.username+"</span>\n" +
                        "            <span class='date'>"+dateFormat(data.comment[i].createDate)+"</span>\n" +
                        "            <textarea rows='3' readonly>"+data.comment[i].comment+"</textarea>\n" +
                        "        </div>\n" +
                        "    </div>";
                }
                $(".comment-div").html(html);
            }else {
                alert("失败");
            }
        });
    };

    $(document).ready(function () {
        showComments();
        showRating([[${ac.rating}]], [[${userNum}]]);
        if ('[[${session.currentUser}]]' != '') {
            myMark();
        }
        $(".left-btn").click(function () {
            updateComments();
        });
        $(".rating a").click(function () {
            $("#rating").attr("checked", "true");
            $(this).siblings().children().attr("src", "/images/star-empty.gif");
            $(this).prevAll().children().attr("src", "/images/star-full.gif");
            $(this).children().attr("src", "/images/star-full.gif");
            var num = $(this).children().attr("alt");
            $("#rating").attr("value", parseInt(num));
        });
        $(".submit").click(function () {
            $("#myModal").modal('hide');
            $.post('/mark?acId=[[${ac.id}]]', $("#mark-form").serialize(),
                function (data, status) {
                    if (status == 'success') {
                        alert(data);
                        myMark();
                        queryRatingData();
                    }
                });
        });
        $("#comment-btn").click(function () {
            $('html, body').animate({scrollTop: $('#comments').offset().top}, 0);
        });
    });
</script>
