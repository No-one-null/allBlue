<!DOCTYPE html >
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${ac.name}"></title>
    <link th:replace="/index :: icon"/>
</head>
<body class="container">
<!-- 导航栏-->
<nav th:replace="/index :: head"></nav>
<a href="#" class="goTop"><img th:src="@{/images/icon/top.gif}" alt="图标"></a>
<div class="col-md-12 panel panel-info">
    <div class="title-div panel-heading">
        <h4><b><span th:text="${ac.name}"></span></b></h4>
    </div>
    <!--详情-->
    <div class="col-md-6 detail-div">
        <div class="img-div-3 back-snow text-center">
            <img th:src="@{${#strings.isEmpty(ac.image)?'/images/none.png':'/images/cover/'+ac.image}}"
                 class="img-rounded img-thumbnail" alt="封面/海报">
        </div>
        <ul class="list-group">
            <li class="list-group-item">
                <b>类别:</b>
                <a th:href="@{'/ac/'+${ac.category}}" th:text="${ac.category=='anime'?'动画':'漫画'}"></a>
            </li>
            <li class="list-group-item"><b th:text="${ac.category}=='comic'?'作者:':'导演:'"></b>
                <span th:each="a : ${ac.author.split(';')}">
                    <a th:href="@{'/search?s='+${a}+'&conditions=author'}" th:text="${a}"></a>　
                </span>
            </li>
            <li class="list-group-item"><b>时间:</b>
                <a th:href="@{'/search?s='+${ac.year}+'&conditions=year'}" th:text="${ac.year}"></a>
            </li>
            <li class="list-group-item"><b>地域:</b>
                <a th:href="@{'/search?s='+${ac.country}+'&conditions=country'}" th:text="${ac.country}"></a>
            </li>
            <li class="list-group-item"><b>标签:</b><i> (例:少年漫画)</i></li>
            <input type="button" class="btn btn-default btn-block" value="更多">
        </ul>
    </div>
    <div class="col-md-6 info-div">
        <pre th:if="${#strings.isEmpty(ac.info)}">暂无简介……<a href="#"><em>添加简介？</em></a></pre>
        <pre th:if="!${#strings.isEmpty(ac.info)}">[[${ac.info}]]</pre>
        <p style="text-align: center"><a href="#"><i>信息有误? 报错！</i> </a></p>
    </div>
    <!--链接-->
    <div class="col-md-6 link-div">
        <h6 class="text-center">相关链接</h6>
        <a class="pull-right" target="_blank" th:href="@{'https://www.baidu.com/s?wd='+${ac.name}}">
            更多…
        </a>
    </div>
    <!--    收藏和评分-->
    <div class="col-md-6 mark-div">
        <div class="rating-div">
            <div class="rating-star-div">
                <div class="cell">
                    <h1></h1>
                    <span class="star">暂无</span><br>
                    <i><span>0</span>人评价</i>
                </div>
            </div>
            <div class="rating-chart-div">
                条形图
            </div>
        </div>
        <div class="my-mark-div">
            <div class="cell">
                <a th:if="${session.currentUser}==null" th:href="@{/login}">登录可收藏该作品</a>
            </div>
        </div>
    </div>
    <div class="col-md-6 comment-btn-div">
        <button type="button" class="btn btn-default btn-block" id="comment-btn">
            <span class="glyphicon glyphicon-thumbs-up"></span> 看看大家的吐槽
            <span class="glyphicon glyphicon-thumbs-down"></span></button>
        <a id="comments" href="javascript:void(0);"></a>
    </div>
</div>
<!--评论区-->
<div class="col-md-12 comment-div"></div>
<!--评论分页-->
<div class="col-md-12 comment-div-bottom">
    <div class="cell">
        <button type="button" class="btn btn-primary left-btn" onclick="location.reload();">
            <span class="glyphicon glyphicon-repeat"></span>刷新
        </button>
        <input type="button" class="btn btn-default right-btn" value="更多">
    </div>
</div>
<div class="col-md-6 comment-model panel-warning" hidden>
    <div class="panel-heading">
        <h3 class="panel-title">吐槽
            <input type="button" value="发布" style="float: right;">
        </h3>
    </div>
    <div class="panel-body">
        <label>
            <textarea style="width: 100%;margin-top: 0" rows="5"></textarea>
        </label>
    </div>
</div>
<!-- 模态框（Modal） -->
<div class="modal fade col-md-12m" id="myModal" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="myModalLabel"></h4>
            </div>
            <div class="modal-body">
                <!--评分评论表单-->
                <form class="form-horizontal mark-form" role="form" id="mark-form">
                    <div class="form-group">
                        <label class="control-label col-md-2">进度</label>
                        <div id="progress" class="col-md-10">
                            <label class="radio-inline">
                                <input type="radio" name="progress" id="wish" value=1>想看
                            </label>
                            <label class="radio-inline">
                                <input type="radio" name="progress" id="do" value=2>在看
                            </label>
                            <label class="radio-inline">
                                <input type="radio" name="progress" id="collect" value=3>看过
                            </label>
                            <label class="radio-inline">
                                <input type="radio" name="progress" id="on_hold" value=4>搁置
                            </label>
                            <label class="radio-inline">
                                <input type="radio" name="progress" id="dropped" value=5>已弃
                            </label>
                        </div>
                    </div>
                    <div class="from-group rating-star">
                        <label for="rating" class="control-label col-md-2">评分</label>
                        <input type="checkbox" name="rating" id="rating" hidden>
                        <div class="col-md-10 rating">
                            <a href="#"><img th:src="@{/images/star-empty.gif}" alt="1"></a>
                            <a href="#"><img th:src="@{/images/star-empty.gif}" alt="2"></a>
                            <a href="#"><img th:src="@{/images/star-empty.gif}" alt="3"></a>
                            <a href="#"><img th:src="@{/images/star-empty.gif}" alt="4"></a>
                            <a href="#"><img th:src="@{/images/star-empty.gif}" alt="5"></a>
                        </div>
                    </div>
                    <br>
                    <div class="form-group">
                        <label for="comment" class="control-label col-md-2">吐槽</label>
                        <textarea id="comment" name="comment" rows="5" class="col-md-10"></textarea>
                    </div>
                    <hr>
                    <div>
                        <button type="button" class="btn btn-primary submit">提交</button>
                        <button type="button" class="btn btn-default" data-dismiss="modal" style="float: right;">关闭
                        </button>
                    </div>
                </form>
            </div>
        </div><!-- /.modal-content -->
    </div>
</div><!-- /.modal -->
</body>
</html>
<script type="text/javascript">
    /**评分**/
    function showRating(rating, userNum) {
        if (rating > 0) {
            $(".rating-star-div div h1").html(numFormat(rating));
        }
        if (rating <= 0) {
            $(".rating-star-div div h1").html("暂无");
        }
        $(".rating-star-div div .star").html(star(rating));
        $(".rating-star-div div i span").html(userNum);
    }

    //查询更新评分
    function queryRatingData() {
        $.post("[[@{/rating}]]",
            {
                acId: [[${ac.id}]]
            }, function (data, status) {
                if (status === 'success') {
                    showRating(data.acRating, data.userNum);
                } else {
                    alert("系统繁忙!");
                }
            });
    }

    //我的收藏
    function myMark() {
        $.ajax({
            url: "[[@{/myMark(acId=${ac.id})}]]",
            dataType: "json",
            type: "post",
            async: "false",
            success: function (data) {
                let html = "<div style='width: 33%;float: left;'>我的评价:";
                if (data.myMark == null) {
                    html += "<a href='javascript:addMark()' title='添加评价'>未评价</a>";
                } else {
                    html += "<a href='javascript:editMark()' title='修改评分'>" +
                        "<span>" + numFormat(data.myMark.rating) + "</span></a>";
                }
                html += "</div><div style='width: 33%;float:left;'>我的吐槽:";
                if (data.myMark == null) {
                    html += "<a href='javascript:addMark()' " +
                        "data-toggle='tooltip' data-placement='top' title='添加吐槽'>暂无</a>";
                } else {
                    html += "<a href='javascript:editMark()' title='修改'> <span>查看</span></a>";
                }
                html += "</div><div style='width: 33%;float:right;'>我的进度:";
                if (data.myMark == null) {
                    html += "<a href='javascript:addMark()' title='添加收藏'>暂无</a>";
                } else {
                    html += "<a href='javascript:editMark()' title='修改进度'>" +
                        "<span>" + progress(data.myMark.progress) + "</span></a>";
                }
                html += "</div>";
                $(".my-mark-div div").html(html); //在html页面id=test的标签里显示html内容
                queryRatingData();
                showComments();
            }
        });
    }

    //添加收藏
    function addMark() {
        $("#progress").find(":radio").removeAttr("checked");
        $(".rating a").children().attr("src", "[[@{/images/star-empty.gif}]]");
        $("#myModalLabel").html("加入收藏");
        $("#myModal").modal();
    }

    //编辑收藏信息
    function editMark() {
        $.post("[[@{/myMark}]]", {acId: [[${ac.id}]]},
            function (data, status) {
                if (status === "success") {
                    $("#progress").find("input[value=" + data.myMark.progress + "]").attr("checked", "true");
                    $(".rating").find("img[alt=" + data.myMark.rating + "]").click();
                    $("#comment").val(data.myMark.comment);
                    $("#myModalLabel").html("修改");
                    $("#myModal").modal();
                } else {
                    alert("系统繁忙,请重试!");
                }
            });
    }

    //显示评论
    const $comment=$(".comment-div");
    function showComments() {
        $.post("[[@{/showComments}]]", {acId: [[${ac.id}]]},
            function (data, status) {
                if (status === 'success') {
                    let html = "";
                    if (data.comment.length <= 0) {
                        $comment.addClass("no-found");
                    } else {
                        $comment.removeClass("no-found");
                    }
                    const kanna="[[@{/images/character/Kanna.gif}]]";
                    if (data.comment.length < 12 && data.comment.length > 0) {
                        html += "<img class='not-much' src='"+kanna+"' alt='评论太少'>";
                    }
                    if (data.comment.length > 0) {
                        for (let i = 0; i < data.comment.length; i++) {
                            html += "<div class='user-comment'" +
                                "        <div class='cell' style='background-color: #8DB6CD;'>\n" +
                                "            <span class='badge'>" + data.comment[i].user.username + "</span>\n"
                                + star(data.comment[i].rating) + "[" + progress(data.comment[i].progress) + "]" +
                                "            <span class='date'>" + fullTime(data.comment[i].createDate) + "</span>\n" +
                                "            <textarea rows='3' readonly>"
                                + data.comment[i].comment + "</textarea>\n" +
                                "        </div>\n" +
                                "    </div>";
                        }
                    }
                    $comment.html(html);
                } else {
                    alert("失败");
                }
            });
    }

    $(document).ready(function () {
        showComments();
        showRating([[${ac.rating}]], [[${userNum}]]);
        if ('[[${session.currentUser}]]' !== '') {
            myMark();
        }
        $(".left-btn").click(function () {
            showComments();
        });
        const $rating=$("#rating");
        $(".rating a").click(function () {
            $rating.attr("checked", "true");
            $(this).siblings().children().attr("src", "[[@{/images/star-empty.gif}]]");
            $(this).prevAll().children().attr("src", "[[@{/images/star-full.gif}]]");
            $(this).children().attr("src", "[[@{/images/star-full.gif}]]");
            let num = $(this).children().attr("alt");
            $rating.attr("value", parseInt(num));
        });
        $(".submit").click(function () {
            $("#myModal").modal('hide');
            $.post('[[@{/mark?acId=}+${ac.id}]]', $("#mark-form").serialize(),
                function (data, status) {
                    if (status === 'success') {
                        alert(data);
                        myMark();
                        queryRatingData();
                    }
                });
        });
        $("#comment-btn").click(function () {
            $('html, body').animate({scrollTop: $('#comments').offset().top}, 0);
        });
    });

    if('1'==='2'){
        addMark();
        editMark();
    }
</script>
